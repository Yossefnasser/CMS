{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}

{% load static %}
<link rel="stylesheet" href="{% static 'css/list.css' %}">

<div class="container-fluid py-4">

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center p-3 rounded shadow-sm" 
     style="background-color: #ffffff;">
                <div>
                    <h2 class="fw-bold text-primary">إدارة المرضى</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 small">
                            <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-dark">الرئيسية</a></li>
                            <li class="breadcrumb-item active text-dark" aria-current="page">المرضى</li>
                        </ol>
                    </nav>
                </div>
                <div class="mt-3 mt-md-0">
                    <button id="addPatientBtn" class="btn btn-primary shadow-sm">
                        <i class="fa fa-plus me-1"></i> إضافة مريض
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Patients Table -->
    <div class="card shadow-sm border-0 rounded-3" >
        <div class="card-body p-3">
            <div class="table-responsive">
                <table id="listTable" class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>المريض</th>
                            <th class="text-center">عرض التفاصيل</th>
                            <th class="text-center">تحديث</th>
                            <th class="text-center">حذف</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block Extrajavascripts %}
<!-- DataTables + Buttons (Bootstrap 5) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>

<script>
  $('#nav-patients').addClass('active')

  // DataTable initialization
  const table = $('#listTable').DataTable({
      processing: true,
      serverSide: true,
      ajax: { url: "/get-list-of-patients" },
      columns: [
          {
              data: null, width: "5%",
              render: (data, type, row, meta) =>
                  meta.row + meta.settings._iDisplayStart + 1
          },
          { data: "name", width: "25%" },
          {
              data: null, className: "text-center",
              render: data =>
                  `<a href="/patient-details?id=${data.hash_id}" class="text-info"><i class="fa fa-info-circle"></i></a>`
          },
          {
              data: null, className: "text-center",
              render: data =>
                  `<a href="/add-patient?type=edit&id=${data.hash_id}" class="text-warning"><i class="fa fa-edit"></i></a>`
          },
          {
              data: null, className: "text-center",
              render: data =>
                  `<a href="javascript:void(0)" class="text-danger" nameOfItem="${data.name}" idOfItem="${data.id}" onclick="askToDeleteItemWithId(this);"><i class="fa fa-trash"></i></a>`
          }
      ],
      language: {
          search: "_INPUT_",
          searchPlaceholder: "ابحث عن مريض...",
          lengthMenu: "عرض _MENU_",
          paginate: { previous: "السابق", next: "التالي" }
      },
      pageLength: 10,
      dom: '<"row mb-3"<"col-sm-6"l><"col-sm-6 text-end"f>>t<"row mt-3"<"col-sm-6"i><"col-sm-6"p>>'
  });

  // Add patient button
  $("#addPatientBtn").on("click", function() {
      window.location.href = '/add-patient?type=new';
  });

  function askToDeleteItemWithId(element) {
      Swal.fire({
          title: 'هل تريد حذف هذا المريض؟',
          icon: 'warning',
          html: `<b>${$(element).attr('nameOfItem')}</b>`,
          showCancelButton: true,
          confirmButtonText: 'نعم، احذف',
          cancelButtonText: 'إلغاء',
          confirmButtonColor: '#d33'
      }).then((result) => {
          if (result.value) {
              $.ajax({
                  type: 'POST',
                  url: '/delete-patient',
                  data: { id: $(element).attr('idOfItem') },
                  headers: { "X-CSRFToken": getCookie('csrftoken') },
                  success: function(res) {
                      if (res.Result == "Success") {
                          Swal.fire('تم الحذف', '', 'success');
                          table.ajax.reload();
                      } else {
                          Swal.fire('خطأ', 'تعذر الحذف', 'error');
                      }
                  }
              });
          }
      });
  }

  function getCookie(name) {
      let cookieValue = null;
      document.cookie.split(';').forEach(cookie => {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          }
      });
      return cookieValue;
  }
</script>
{% endblock %}
