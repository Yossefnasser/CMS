{% load static %}
<div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="patientModalLabel">
          <i class="fas fa-user-plus me-2"></i>
          تسجيل مريض جديد
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="patientForm" method="post" action="{% url 'add_patient' %}">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="full_name" class="form-label">الاسم الكامل</label>
              <input type="text" class="form-control" id="full_name" name="full_name" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="phone" class="form-label">رقم الجوال</label>
              <input type="tel" class="form-control" id="phone" name="phone" required>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="notes" class="form-label">ملاحظات</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="emergency_contact">
            <label class="form-check-label" for="emergency_contact">
              إضافة معلومات الاتصال في حالات الطوارئ
            </label>
          </div>
        </form>
      </div>
    <div  id="patientModal" >
  <!-- ... (keep existing modal header and form fields) ... -->
  
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
    <button type="submit" name="action" value="save" class="btn btn-primary">
      حفظ البيانات
    </button>
    <button type="submit" name="action" value="save_and_book" class="btn btn-success">
      <i class="fas fa-calendar-plus me-1"></i> حفظ وحجز موعد
    </button>
  </div>

<!-- Add this hidden appointment modal (will be triggered after save) -->
<div class="modal fade" id="appointmentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">حجز موعد للمريض الجديد</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- This will be filled dynamically -->
        <div id="appointmentFormContainer"></div>
      </div>
    </div>
  </div>
  </div>
</div>
<script>
// Handle patient form submission
document.getElementById('patientForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const action = e.submitter.value; // 'save' or 'save_and_book'
  
  try {
    const response = await fetch(this.action, {
      method: 'POST',
      body: formData,
      headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') }
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Close patient modal
      bootstrap.Modal.getInstance(document.getElementById('patientModal')).hide();
      
      if (action === 'save_and_book' && data.patient_id) {
        // Load appointment form with patient pre-selected
        const appointmentUrl = `/appointments/new/?patient_id=${data.patient_id}`;
        const response = await fetch(appointmentUrl);
        const html = await response.text();
        
        document.getElementById('appointmentFormContainer').innerHTML = html;
        const appointmentModal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        appointmentModal.show();
      } else {
        location.reload(); // Just refresh if only saving
      }
    }
  } catch (error) {
    console.error('Error:', error);
  }
});